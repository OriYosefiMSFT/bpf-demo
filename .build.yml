image: debian/buster
environment:
  GITHUB_DELIVERY: 14eb7d04-7dce-11ea-9ece-ee773dea201e
  GITHUB_EVENT: push
  GITHUB_REF: refs/heads/master
  GITHUB_REPO: alexeldeib/az-local-pvc
  IMAGE: az-local-pvc
  REPO: docker.io/alexeldeib
packages:
- curl
- gpg
- apt-transport-https
repositories: null
secrets:
- 7bb48981-fc03-4344-bae3-736c99f94f49
- 21bdadaa-095c-4968-9a6e-ce9b795042b4
shell: null
sources:
- https://github.com/alexeldeib/bpf-demo
tasks:
- install: |
    set -o errexit
    set -o nounset
    set -o pipefail
- build: |
    set -o errexit
    set -o nounset
    set -o pipefail

    cd ~/bpf-demo

    # systemd drop-in for docker networking
    sudo mkdir -p /etc/systemd/system/docker.service.d
    sudo cp ./build/10-docker-net.conf /etc/systemd/system/docker.service.d/10-docker-net.conf

    curl -fsSl https://download.docker.com/linux/ubuntu/gpg -o gpg.asc
    sudo apt-key add gpg.asc

    DISTRO="$(cat /etc/os-release | grep ^ID= | cut -d= -f2)"
    CODENAME="$(cat /etc/os-release | grep VERSION_CODENAME= | cut -d= -f2)"

    echo "deb [arch=amd64] https://download.docker.com/linux/${DISTRO} ${CODENAME} stable" \
      | sudo tee /etc/apt/sources.list.d/docker.list

    sudo apt update && sudo apt install docker-ce

    cat ~/.docker_pass | sudo docker login -u $(cat ~/.docker_user) --password-stdin
    
    ./build/build.sh
